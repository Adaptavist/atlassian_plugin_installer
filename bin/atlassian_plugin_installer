#!/usr/bin/env ruby
require 'atlassian_plugin_installer'
require 'marketplace_accessor'

admin_username = ARGV[0]
admin_password = ARGV[1] == "" ? ENV['ADMIN_PASS'] : ARGV[1]
application_url = ARGV[2]
plugin_key = ARGV[3]
plugin_version = ARGV[4]
marketplace_username = ARGV[5]
marketplace_password = ARGV[6] == "" ? ENV['MARKETPLACE_PASS'] : ARGV[6]
license = ARGV[7]

if !(admin_username and admin_password and application_url and plugin_key and plugin_version and marketplace_username and marketplace_password)
    puts "Usage: atlassian_plugin_installer admin_username admin_password application_url plugin_key plugin_version marketplace_username marketplace_password"
    exit
end

# retrieve build number for plugin version
marketplace = AtlassianPluginInstaller::MarketplaceAccessor.new(marketplace_username, marketplace_password)
plugin_build_number = marketplace.resolve_build_number_from_marketplace(plugin_key, plugin_version)

installer = AtlassianPluginInstaller::AtlassianPluginInstaller.new(application_url, admin_username, admin_password)
# request access token
token = installer.fetch_application_access_token

# install plugin using the token
installer.install_plugin(plugin_key, plugin_build_number, token)

unless (installer.installation_completed(plugin_key))
    raise "Installation failed, plugin not available."
end

if license
    installer.install_license(plugin_key, license)
end
